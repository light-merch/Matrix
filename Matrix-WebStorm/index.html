<!DOCTYPE HTML>
<html>
    <head>
        <title>Matrix</title>


        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100%; }
        </style>
    </head>

    <body>
        <script src="build/stats.min.js"></script>
        <script src="build/dat.gui.min.js"></script>
        <script src="game_mechanics.js"></script>


        <script type="module">
            import * as THREE from "./build/three.module.js";

            import { OrbitControls } from './build/OrbitControls.js';
            import { GLTFLoader } from './build/GLTFLoader.js';
            import { DRACOLoader } from './build/DRACOLoader.js';


            const FizzyText = function () {
                this.message = 'dat.gui';
                this.light = 0.5;
                this.matrix_style = false;
                this.explode = function () {
                };
            };

            const loadTextures = function (path, is_matrix) {
                let material;
                if (is_matrix) {
                    material = new THREE.MeshBasicMaterial({color: 0x00ff00, wireframe: true});
                } else {
                    material = [
                        new THREE.MeshLambertMaterial({map: new THREE.TextureLoader().load(path), side: THREE.DoubleSide}), // RIGHT SIDE
                        new THREE.MeshLambertMaterial({map: new THREE.TextureLoader().load(path), side: THREE.DoubleSide}), // LEFT SIDE
                        new THREE.MeshLambertMaterial({map: new THREE.TextureLoader().load(path), side: THREE.DoubleSide}), // TOP SIDE
                        new THREE.MeshLambertMaterial({map: new THREE.TextureLoader().load(path), side: THREE.DoubleSide}), // BOTTOM SIDE
                        new THREE.MeshLambertMaterial({map: new THREE.TextureLoader().load(path), side: THREE.DoubleSide}), // FRONT SIDE
                        new THREE.MeshLambertMaterial({map: new THREE.TextureLoader().load(path), side: THREE.DoubleSide})  // BACK SIDE
                    ];
                }
                return material;
            };

            window.onload = function() {
                const text = new FizzyText();
                const gui = new dat.GUI();
                gui.add(text, 'message');
                var control = gui.add(text, 'light', 0, 1);
                var matrix = gui.add(text, 'matrix_style');
                gui.add(text, 'explode');

                control.onChange(function(value){
                    // press F
                });

                matrix.onChange(function(value){
                    while(scene.children.length > 0){
                        scene.remove(scene.children[0]);
                    }

                    IS_MATRIX = !!value;
                    add_textures(IS_MATRIX);
                });
            };



            var IS_MATRIX = true;

            var stats = initStats();
            var scene = new THREE.Scene();
            var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            window.addEventListener('resize', function() {
                var width = window.innerWidth;
                var height = window.innerHeight;
                renderer.setSize(width, height);
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
            });

            document.addEventListener('keydown', onDocumentKeyDown, false);
            function onDocumentKeyDown(event) {
                var keyCode = event.which;
                if (keyCode === 87) {
                    cube.position.y += 1;
                } else if (keyCode === 83) {
                    cube.position.y -= 1;
                } else if (keyCode === 65) {
                    cube.position.x -= 1;
                } else if (keyCode === 68) {
                    cube.position.x += 1;
                } else if (keyCode === 32) {
                    cube.position.set(0, 0, 0);
                }
            }

            const wood = 'textures/wood.jpg';
            const wood2 = 'textures/wood2.jpg';
            const concrete = 'textures/concrete.jpg';

            var controls = new OrbitControls(camera, renderer.domElement);
            camera.position.z = 5;

            // envmap
            var path = 'textures/Park2/';
            var format = '.jpg';
            var envMap = new THREE.CubeTextureLoader().load( [
                path + 'posx' + format, path + 'negx' + format,
                path + 'posy' + format, path + 'negy' + format,
                path + 'posz' + format, path + 'negz' + format
            ] );

            var dracoLoader = new DRACOLoader();
            dracoLoader.setDecoderPath('build/gltf/');

            var loader = new GLTFLoader();
            loader.setDRACOLoader(dracoLoader);

            loader.load('models/tokyo.glb', function (gltf) {
                var model = gltf.scene;
                model.position.set(1, 1.5, 0);
                model.scale.set(0.01, 0.01, 0.01);
                model.traverse(function(child) {
                    if (child.isMesh) child.material.envMap = envMap;
                });
                scene.add(model);
                mixer = new THREE.AnimationMixer(model);
                mixer.clipAction(gltf.animations[0]).play();
                animate();
            }, undefined, function (e) {
                console.error(e);
            });

            var add_textures = function(is_matrix) {
                // create the shape
                var geometry = new THREE.BoxGeometry(1, 1, 1);

                var cubeMaterials = loadTextures(wood, is_matrix);
                // create a material, color or image texture
                var material = new THREE.MeshFaceMaterial(cubeMaterials);
                var cube = new THREE.Mesh(geometry, material);

                scene.add(cube);


                // floor
                var geometry = new THREE.BoxGeometry(0.5, 10, 10);
                var floorMaterials = loadTextures(concrete, is_matrix);
                var floor = new THREE.Mesh(geometry, floorMaterials);
                floor.position.set(0, -1, 0);
                floor.rotation.z = 1.57
                scene.add(floor);


                // light
                var ambientLight = new THREE.AmbientLight(0xFFFFFF, 0.8);
                scene.add(ambientLight);

                var light1 = new THREE.PointLight(0xFFFFFF, 0.5, 500);
                light1.position.set(3, 2, 2);
                scene.add(light1);

                // light position
                var geometry = new THREE.SphereGeometry(0.1, 5, 5);
                var material = new THREE.MeshBasicMaterial({color: 0x0000FF, wireframe: true});
                var point = new THREE.Mesh(geometry, material);
                point.position.set(3, 2, 2);
                scene.add(point);
            }
            add_textures();

            // game logic
            var update = function() {
                // light1.position.x += 0.1;
                // cube.rotation.x += 0.01;
                // cube.rotation.y += 0.005;
            };

            // draw scene
            var render = function() {
                renderer.render(scene, camera);
            };

            // run game loop (update, render, repeat)
            var GameLoop = function() {
                requestAnimationFrame(GameLoop);
                stats.begin();

                update();
                render();
                stats.end();
            };

            GameLoop();

            function initStats() {
                var stats = new Stats();
                stats.setMode(0); // 0: fps, 1: ms

                // Align top-left
                stats.domElement.style.position = 'absolute';
                stats.domElement.style.left = '0px';
                stats.domElement.style.top = '0px';

                document.body.appendChild(stats.dom);
                return stats;
            }
        </script>
    </body>
</html>